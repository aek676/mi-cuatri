---
import { createApiClient } from '@/lib/apiClient';

const {
  avatarUrl,
  sessionToken,
  size = 100,
  alt = 'Avatar',
  className = '',
  showSkeleton = true,
} = Astro.props as {
  avatarUrl: string;
  sessionToken?: string;
  size?: number;
  alt?: string;
  className?: string;
  showSkeleton?: boolean;
};

let imageSrc: string | null = null;

if (avatarUrl && sessionToken) {
  try {
    const api = createApiClient(sessionToken);
    const response = await api.api.imageProxyList({ imageUrl: avatarUrl });

    if (response.data) {
      const blob = response.data as unknown as Blob;
      const buffer = await blob.arrayBuffer();
      const base64 = btoa(String.fromCharCode(...new Uint8Array(buffer)));
      const contentType = blob.type || 'image/jpeg';
      imageSrc = `data:${contentType};base64,${base64}`;
    }
  } catch (err) {
    console.error('Failed to fetch avatar image:', err);
    imageSrc = null;
  }
}

const fallbackUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(alt)}&size=256&background=6B9AC4&color=fff`;
---

{
  imageSrc ? (
    <img
      src={imageSrc}
      alt={alt}
      loading="lazy"
      decoding="async"
      class={`rounded-full object-cover ${className}`}
      style={`width: ${size}px; height: ${size}px;`}
    />
  ) : (
    <img
      src={fallbackUrl}
      alt={alt}
      loading="lazy"
      decoding="async"
      class={`rounded-full object-cover ${className}`}
      style={`width: ${size}px; height: ${size}px;`}
    />
  )
}
